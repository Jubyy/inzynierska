{% extends 'base.html' %}

{% block title %}Statystyki Aplikacji{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Panel Administratora - Statystyki</h1>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Na tej stronie znajdziesz statystyki dotyczące całej aplikacji, w tym informacje o użytkownikach, przepisach i składnikach.
    </div>
    
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="h2 mb-0 text-primary">{{ users_count }}</h3>
                    <p class="text-muted mb-0">Użytkowników</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="h2 mb-0 text-primary">{{ recipes_count }}</h3>
                    <p class="text-muted mb-0">Przepisów</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="h2 mb-0 text-primary">{{ ingredients_count }}</h3>
                    <p class="text-muted mb-0">Składników</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h3 class="h2 mb-0 text-primary">{{ avg_rating }}</h3>
                    <p class="text-muted mb-0">Średnia Ocena</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Najlepiej oceniane przepisy</h2>
                </div>
                <div class="card-body">
                    {% if top_recipes %}
                        <div class="list-group">
                            {% for recipe in top_recipes %}
                                <a href="{% url 'recipes:detail' recipe.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    {{ recipe.title }}
                                    <span class="badge bg-primary rounded-pill">{{ recipe.avg_rating|floatformat:1 }} ★</span>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Brak ocenianych przepisów</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Najpopularniejsze przepisy</h2>
                </div>
                <div class="card-body">
                    {% if popular_recipes %}
                        <div class="list-group">
                            {% for recipe in popular_recipes %}
                                <a href="{% url 'recipes:detail' recipe.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    {{ recipe.title }}
                                    <span class="badge bg-primary rounded-pill">{{ recipe.likes_count }} polubień</span>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Brak popularnych przepisów</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nowa sekcja ze statystykami jednostek miary -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Najczęściej używane jednostki miary</h2>
                </div>
                <div class="card-body">
                    {% if measurement_unit_stats %}
                        <div class="list-group">
                            {% for unit in measurement_unit_stats %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ unit.name }} ({{ unit.symbol }})</h6>
                                        <small class="text-muted">{{ unit.get_type_display }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ unit.usage_count }} użyć</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Brak danych o jednostkach miary</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Najczęściej używane kategorie składników</h2>
                </div>
                <div class="card-body">
                    {% if ingredient_category_stats %}
                        <div class="list-group">
                            {% for category in ingredient_category_stats %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ category.name }}</h6>
                                        <small class="text-muted">
                                            {% if category.is_vegetarian %}Wegetariańska{% endif %}
                                            {% if category.is_vegan %}{% if category.is_vegetarian %}, {% endif %}Wegańska{% endif %}
                                        </small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ category.usage_count }} użyć</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Brak danych o kategoriach składników</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wykres aktywności w czasie -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Aktywność w ostatnich 6 miesiącach</h2>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'recipes:admin_dashboard' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i> Powrót do panelu administratora
        </a>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dane dla wykresu aktywności
    var ctx = document.getElementById('activityChart').getContext('2d');
    var activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ months_labels|safe }},
            datasets: [{
                label: 'Nowe przepisy',
                data: {{ recipes_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Liczba przepisów'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Miesiąc'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Liczba nowych przepisów w czasie'
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %} 