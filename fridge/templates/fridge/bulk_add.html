{% extends 'base.html' %}

{% block title %}Zbiorcze dodawanie produktów do lodówki{% endblock %}

{% block extra_css %}
<style>
    .select2-container {
        width: 100% !important;
    }
    
    .select2-container--default .select2-results__group {
        background-color: #f8f9fa;
        font-weight: bold;
        padding: 6px 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .select2-results__option {
        padding-left: 20px;
    }
    
    .category-heading {
        font-weight: bold;
        padding: 8px 15px;
        margin-top: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #2b5797;
    }
    
    .ingredient-row {
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
        padding: 10px;
        border-radius: 8px;
    }
    
    .ingredient-row:hover {
        background-color: #f8f9fa;
    }
    
    .ingredient-row .form-label {
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Zbiorcze dodawanie produktów do lodówki</h2>
        </div>
        <div class="card-body">
            <form method="post" id="bulk-add-form">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {{ formset.management_form }}
                
                <div id="formset-container">
                    {% for form in formset %}
                    <div class="ingredient-row card mb-3 p-3">
                        <button type="button" class="btn btn-outline-danger btn-sm position-absolute end-0 top-0 m-2 delete-row" title="Usuń wiersz">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        
                        <div class="row">
                            <div class="col-12 col-md-6 mb-3">
                                <label for="id_form-{{ forloop.counter0 }}-ingredient" class="form-label">Składnik:</label>
                                {{ form.ingredient }}
                            </div>
                            <div class="col-12 col-md-6 mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="id_form-{{ forloop.counter0 }}-amount" class="form-label">Ilość:</label>
                                        {{ form.amount }}
                                    </div>
                                    <div class="col-6">
                                        <label for="id_form-{{ forloop.counter0 }}-unit" class="form-label">Jednostka:</label>
                                        {{ form.unit }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <label for="id_form-{{ forloop.counter0 }}-expiry_date" class="form-label">Data ważności:</label>
                                {{ form.expiry_date }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" id="add-more" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>Dodaj więcej produktów
                    </button>
                    
                    <div>
                        <a href="{% url 'fridge:list' %}" class="btn btn-outline-secondary me-2">Anuluj</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Zapisz wszystkie produkty
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        var formsetPrefix = 'form';
        var totalFormsInput = $('#id_' + formsetPrefix + '-TOTAL_FORMS');
        var formCount = parseInt(totalFormsInput.val());
        
        // Inicjalizacja Select2 dla wszystkich rozwijanek składników
        initializeSelect2();
        
        // Dodaj więcej produktów
        $('#add-more').click(function() {
            var newForm = $('.ingredient-row:first').clone(true);
            
            // Zaktualizuj indeksy w nowym formularzu
            updateElementIndex(newForm, formsetPrefix, formCount);
            
            // Wyczyść wartości
            newForm.find('input:not([type=hidden])').val('');
            newForm.find('select').val(null);
            
            // Dodaj nowy formularz do kontenera
            $('#formset-container').append(newForm);
            
            // Zwiększ licznik formularzy
            formCount++;
            totalFormsInput.val(formCount);
            
            // Zainicjalizuj Select2 dla nowego formularza
            initializeSelect2ForElement(newForm);
        });
        
        // Usuń wiersz
        $('.delete-row').click(function() {
            // Nie usuwaj, jeśli to jedyny wiersz
            if ($('.ingredient-row').length > 1) {
                $(this).closest('.ingredient-row').remove();
                
                // Zmniejsz licznik formularzy
                formCount--;
                totalFormsInput.val(formCount);
                
                // Zaktualizuj indeksy
                $('.ingredient-row').each(function(index) {
                    updateElementIndex($(this), formsetPrefix, index);
                });
            } else {
                alert('Musi pozostać przynajmniej jeden wiersz.');
            }
        });
        
        // Funkcja do aktualizacji indeksów w formularzach
        function updateElementIndex(element, prefix, index) {
            var idRegex = new RegExp('(' + prefix + '-(\\d+|__prefix__))');
            var replacement = prefix + '-' + index;
            
            // Aktualizuj atrybuty name i id
            element.find('*').each(function() {
                var attr = $(this).attr('name');
                if (attr) {
                    attr = attr.replace(idRegex, replacement);
                    $(this).attr('name', attr);
                }
                
                attr = $(this).attr('id');
                if (attr) {
                    attr = attr.replace(idRegex, replacement);
                    $(this).attr('id', attr);
                }
                
                attr = $(this).attr('for');
                if (attr) {
                    attr = attr.replace(idRegex, replacement);
                    $(this).attr('for', attr);
                }
            });
        }
        
        // Inicjalizuj Select2 dla wszystkich formularzy
        function initializeSelect2() {
            $('.ingredient-row').each(function(index) {
                initializeSelect2ForElement($(this));
            });
        }
        
        // Inicjalizuj Select2 dla konkretnego elementu
        function initializeSelect2ForElement(element) {
            // Inicjalizacja Select2 dla składników z grupowaniem
            element.find('select[id$="-ingredient"]').select2({
                placeholder: "Wybierz składnik lub wyszukaj...",
                allowClear: true,
                theme: "bootstrap4",
                dropdownParent: element,
                templateResult: formatIngredient,
                escapeMarkup: function(m) { return m; }
            }).on('change', function() {
                // Przy zmianie składnika, załaduj kompatybilne jednostki
                var ingredientId = $(this).val();
                var unitSelect = $(this).closest('.ingredient-row').find('select[id$="-unit"]');
                
                if (ingredientId) {
                    loadCompatibleUnits(ingredientId, unitSelect);
                }
            });
            
            // Inicjalizacja Select2 dla jednostek
            element.find('select[id$="-unit"]').select2({
                placeholder: "Wybierz jednostkę",
                allowClear: true,
                theme: "bootstrap4",
                dropdownParent: element
            });
        }
        
        // Funkcja do formatowania opcji w Select2
        function formatIngredient(ingredient) {
            if (!ingredient.id) {
                return ingredient.text;
            }
            
            // Jeśli to kategoria
            if (ingredient.children) {
                return '<div class="category-heading">' + ingredient.text + '</div>';
            }
            
            // Zwykły składnik
            return '<div>' + ingredient.text + '</div>';
        }
        
        // Funkcja do ładowania kompatybilnych jednostek dla wybranego składnika
        function loadCompatibleUnits(ingredientId, unitSelect) {
            $.ajax({
                url: '{% url "fridge:ajax_compatible_units" %}',
                data: {'ingredient_id': ingredientId},
                dataType: 'json',
                success: function(data) {
                    unitSelect.empty();
                    
                    // Dodaj pobrane jednostki do listy
                    $.each(data.units, function(index, unit) {
                        unitSelect.append($('<option></option>')
                            .attr('value', unit.id)
                            .text(unit.name));
                    });
                    
                    // Jeśli jest domyślna jednostka, ustaw ją
                    if (data.default_unit) {
                        unitSelect.val(data.default_unit);
                    }
                    
                    // Odśwież Select2
                    unitSelect.trigger('change');
                }
            });
        }
    });
</script>
{% endblock %} 