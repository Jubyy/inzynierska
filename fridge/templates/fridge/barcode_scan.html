{% extends 'base.html' %}

{% block title %}Skanowanie kodów kreskowych{% endblock %}

{% block extra_css %}
<style>
    #barcode-scanner {
        width: 100%;
        height: 300px;
        border: 2px solid #0d6efd;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }
    
    #scanner-message {
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        z-index: 10;
    }
    
    #scanner-container {
        position: relative;
        margin-bottom: 20px;
    }
    
    .scan-line {
        position: absolute;
        width: 100%;
        height: 5px;
        background: linear-gradient(to right, transparent, #0d6efd, transparent);
        animation: scan 2s linear infinite;
        top: 50%;
        z-index: 9;
    }
    
    @keyframes scan {
        0% { top: 0; }
        50% { top: 100%; }
        100% { top: 0; }
    }
    
    .product-image {
        max-height: 200px;
        object-fit: contain;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    
    #debug-canvas {
        width: 100%;
        height: 300px;
        display: none;
    }
    
    #camera-permission-info {
        display: none;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Skanowanie kodów kreskowych</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="lead">Możesz dodać produkty do lodówki poprzez:</p>
                            <ul class="list-group mb-4">
                                <li class="list-group-item">
                                    <i class="bi bi-upc-scan me-2"></i> Skanowanie kodu kreskowego przy użyciu kamery
                                </li>
                                <li class="list-group-item">
                                    <i class="bi bi-keyboard me-2"></i> Ręczne wprowadzenie kodu kreskowego
                                </li>
                            </ul>
                            
                            <div class="form-group mb-3">
                                <label for="manual-barcode" class="form-label">Ręczne wprowadzenie kodu:</label>
                                <div class="input-group">
                                    <input type="text" id="manual-barcode" class="form-control" placeholder="np. 5900512300105">
                                    <button id="manual-search" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Szukaj
                                    </button>
                                </div>
                                <small class="form-text text-muted">Wprowadź kod kreskowy produktu i kliknij "Szukaj"</small>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button id="start-scanner" class="btn btn-success">
                                    <i class="bi bi-camera"></i> Uruchom skaner kamery
                                </button>
                                <button id="stop-scanner" class="btn btn-danger" style="display: none;">
                                    <i class="bi bi-camera-video-off"></i> Zatrzymaj skaner
                                </button>
                            </div>
                            
                            <div id="camera-permission-info" class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i> Aby skaner działał, musisz zezwolić na dostęp do kamery.
                            </div>
                            
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="enable-debug">
                                <label class="form-check-label" for="enable-debug">
                                    Włącz tryb debugowania (lokalizacja kodu)
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="scanner-container">
                                <div id="barcode-scanner">
                                    <div id="scanner-message">
                                        <p>Naciśnij "Uruchom skaner kamery", aby rozpocząć skanowanie</p>
                                    </div>
                                </div>
                                <div class="scan-line"></div>
                                <canvas id="debug-canvas"></canvas>
                            </div>
                            
                            <div class="text-center mb-3">
                                <small class="text-muted">Skieruj kod kreskowy w stronę kamery, aby go zeskanować</small>
                            </div>
                            
                            <div class="d-flex justify-content-center mb-3">
                                <select id="camera-select" class="form-select" style="display: none;">
                                    <option value="">Wybierz kamerę...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loading-spinner" id="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ładowanie...</span>
                        </div>
                        <p class="mt-2">Wyszukiwanie produktu...</p>
                    </div>
                    
                    <!-- Wynik wyszukiwania produktu -->
                    <div id="product-result" class="mt-4" style="display: none;">
                        <hr>
                        <h3>Znaleziony produkt</h3>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <img id="product-image" src="" alt="Zdjęcie produktu" class="product-image img-fluid mb-3">
                            </div>
                            <div class="col-md-8">
                                <h4 id="product-name" class="mb-3"></h4>
                                <p id="product-barcode" class="mb-2"></p>
                                <p id="product-quantity" class="mb-2"></p>
                                <p id="product-categories" class="mb-3"></p>
                                
                                <form id="add-to-fridge-form">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="product-amount" class="form-label">Ilość</label>
                                            <input type="number" id="product-amount" class="form-control" value="1" min="0.01" step="0.01" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="product-unit" class="form-label">Jednostka</label>
                                            <select id="product-unit" class="form-select" required>
                                                <option value="">Wybierz jednostkę</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="product-expiry" class="form-label">Data ważności</label>
                                            <input type="date" id="product-expiry" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-plus-circle"></i> Dodaj do lodówki
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Komunikat o błędzie -->
                    <div id="error-message" class="alert alert-danger mt-4" style="display: none;"></div>
                </div>
                <div class="card-footer">
                    <a href="{% url 'fridge:list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Wróć do listy produktów
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="product-form" style="display: none;" class="mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Dodaj produkt do lodówki</h3>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3 text-center">
                    <img id="product-image" src="" alt="Zdjęcie produktu" style="max-width: 100%; max-height: 120px; display: none;">
                </div>
                <div class="col-md-9">
                    <h5 id="product-name" class="mb-2"></h5>
                    <p id="product-barcode" class="mb-2"></p>
                    <p id="product-category" class="mb-2 text-muted small"></p>
                </div>
            </div>
            
            <!-- Podobne składniki -->
            <div id="similar-ingredients-container" class="mb-4" style="display: none;">
                <h5>Podobne składniki w bazie danych:</h5>
                <div class="alert alert-info">
                    <p>Znaleźliśmy podobne składniki w bazie danych. Wybierz jeden z nich lub dodaj nowy produkt.</p>
                </div>
                <div id="similar-ingredients" class="list-group mb-3">
                    <!-- Tutaj będą dodawane dynamicznie podobne składniki -->
                </div>
                <div class="mb-3">
                    <button id="use-new-product" class="btn btn-outline-primary">Dodaj jako nowy składnik</button>
                </div>
            </div>
            
            <form id="add-product-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="ingredient" class="form-label">Nazwa produktu</label>
                        <input type="text" id="ingredient" name="ingredient" class="form-control" required>
                        <input type="hidden" id="ingredient-id" name="ingredient_id">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="amount" class="form-label">Ilość</label>
                        <input type="number" id="amount" name="amount" class="form-control" min="0.01" step="0.01" value="1" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="unit" class="form-label">Jednostka</label>
                        <select id="unit" name="unit" class="form-select" required>
                            {% for unit in units %}
                                <option value="{{ unit.id }}">{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="expiry_date" class="form-label">Data ważności (opcjonalnie)</label>
                    <input type="date" id="expiry_date" name="expiry_date" class="form-control">
                </div>
                <input type="hidden" id="barcode" name="barcode">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Dodaj do lodówki
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Dodanie biblioteki do skanowania kodów kreskowych -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
    $(document).ready(function() {
        let scanner = null;
        let cameras = [];
        let lastDetectedCode = null;
        let detectionCount = 0;
        
        // Sprawdź możliwość dostępu do kamer
        function checkCameraAccess() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError("Twoja przeglądarka nie obsługuje dostępu do kamery. Użyj nowszej przeglądarki lub wprowadź kod ręcznie.");
                $("#start-scanner").prop('disabled', true);
                return false;
            }
            
            // Sprawdź dostępne kamery
            if (navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(function(devices) {
                        cameras = devices.filter(device => device.kind === 'videoinput');
                        console.log('Dostępne kamery:', cameras);
                        
                        if (cameras.length > 1) {
                            // Wypełnij listę kamer
                            const cameraSelect = $("#camera-select");
                            cameraSelect.empty().append('<option value="">Wybierz kamerę...</option>');
                            
                            cameras.forEach((camera, index) => {
                                const label = camera.label || `Kamera ${index + 1}`;
                                cameraSelect.append(`<option value="${camera.deviceId}">${label}</option>`);
                            });
                            
                            cameraSelect.show();
                        }
                    })
                    .catch(function(err) {
                        console.error('Błąd pobierania listy kamer:', err);
                    });
            }
            
            return true;
        }
        
        // Sprawdź dostęp do kamer na starcie
        checkCameraAccess();
        
        // Pobierz dostępne jednostki
        function loadUnits() {
            $.ajax({
                url: "{% url 'fridge:ajax_load_units' %}",
                type: "GET",
                success: function(data) {
                    let select = $("#product-unit");
                    select.empty().append('<option value="">Wybierz jednostkę</option>');
                    
                    if (data.units && Array.isArray(data.units)) {
                        $.each(data.units, function(i, unit) {
                            select.append(new Option(unit.name, unit.id));
                        });
                    }
                },
                error: function(xhr, status, error) {
                    showError("Błąd podczas ładowania jednostek: " + error);
                }
            });
        }
        
        // Wczytaj jednostki przy starcie
        loadUnits();
        
        // Funkcja inicjalizująca skaner kodów kreskowych
        function initBarcodeScanner(deviceId = null) {
            if (scanner) {
                Quagga.stop();
                scanner = null;
            }
            
            $("#camera-permission-info").show();
            
            try {
                const constraints = {
                    width: { min: 640 },
                    height: { min: 480 },
                    facingMode: "environment", // Preferuj tylną kamerę
                    aspectRatio: { min: 1, max: 2 }
                };
                
                // Jeśli wybrano konkretną kamerę, użyj jej
                if (deviceId) {
                    constraints.deviceId = { exact: deviceId };
                    delete constraints.facingMode;
                }
                
                // Konfiguracja skanera
                const config = {
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector("#barcode-scanner"),
                        constraints: constraints,
                        area: { // Ogranicz obszar wyszukiwania kodów do środka obrazu
                            top: "20%",
                            right: "20%",
                            left: "20%",
                            bottom: "20%"
                        }
                    },
                    locator: {
                        patchSize: "medium", // x-small, small, medium, large, x-large
                        halfSample: true
                    },
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader",
                            "code_128_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader",
                            "i2of5_reader"
                        ],
                        multiple: false,
                        debug: {
                            drawBoundingBox: $("#enable-debug").is(":checked"),
                            showFrequency: $("#enable-debug").is(":checked"),
                            drawScanline: $("#enable-debug").is(":checked"),
                            showPattern: $("#enable-debug").is(":checked")
                        }
                    },
                    locate: true,
                    frequency: 10 // Częstotliwość skanowania (klatek na sekundę)
                };
                
                // Użyj canvasa w trybie debug
                if ($("#enable-debug").is(":checked")) {
                    $("#debug-canvas").show();
                    config.inputStream.target = document.querySelector("#debug-canvas");
                } else {
                    $("#debug-canvas").hide();
                }
                
                // Inicjalizacja skanera
                Quagga.init(config, function(err) {
                    if (err) {
                        console.error("Błąd inicjalizacji skanera:", err);
                        showError("Nie udało się uruchomić skanera: " + err);
                        $("#start-scanner").prop('disabled', false);
                        return;
                    }
                    
                    // Wszystko OK, uruchom skaner
                    scanner = true;
                    Quagga.start();
                    $("#scanner-message").hide();
                    $("#stop-scanner").show();
                    $("#start-scanner").hide();
                    $("#camera-permission-info").hide();
                });
                
                // Obsługa wykrycia kodu
                Quagga.onDetected(function(result) {
                    if (!result || !result.codeResult || !result.codeResult.code) {
                        return;
                    }
                    
                    const barcode = result.codeResult.code;
                    const confidence = result.codeResult.confidence;
                    
                    console.log(`Wykryto kod: ${barcode}, pewność: ${confidence}`);
                    
                    // Dodanie weryfikacji - kod musi być wykryty kilka razy z rzędu z dużą pewnością
                    if (confidence < 0.7) {
                        console.log("Zbyt niska pewność, ignorowanie...");
                        return;
                    }
                    
                    if (lastDetectedCode === barcode) {
                        detectionCount++;
                        
                        // Jeśli ten sam kod został wykryty co najmniej 3 razy, uznaj go za prawidłowy
                        if (detectionCount >= 3) {
                            // Zatrzymaj skaner po wykryciu kodu
                            Quagga.stop();
                            scanner = null;
                            
                            $("#stop-scanner").hide();
                            $("#start-scanner").show();
                            $("#scanner-message").html("<p>Kod kreskowy wykryty: " + barcode + "</p>").show();
                            
                            // Wyszukaj produkt po kodzie kreskowym
                            searchProductByBarcode(barcode);
                            
                            // Zresetuj licznik wykryć
                            lastDetectedCode = null;
                            detectionCount = 0;
                        }
                    } else {
                        // Nowy kod, zresetuj licznik
                        lastDetectedCode = barcode;
                        detectionCount = 1;
                    }
                });
                
                // Obsługa zmiany rozmiaru
                $(window).on('resize', function() {
                    if (scanner) {
                        Quagga.stop();
                        scanner = null;
                        setTimeout(() => initBarcodeScanner(deviceId), 500);
                    }
                });
            } catch (error) {
                console.error("Błąd inicjalizacji skanera:", error);
                showError("Błąd inicjalizacji skanera: " + error.message);
                $("#start-scanner").prop('disabled', false);
            }
        }
        
        // Uruchom skaner po kliknięciu przycisku
        $("#start-scanner").on("click", function() {
            $(this).prop('disabled', true);
            
            // Sprawdź uprawnienia do kamery
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    // Zatrzymaj strumień - Quagga i tak stworzy własny
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Pobierz wybrane ID kamery (jeśli wybrano)
                    const selectedCameraId = $("#camera-select").val();
                    
                    // Inicjalizuj skaner z wybraną kamerą lub domyślną
                    initBarcodeScanner(selectedCameraId || null);
                    $("#start-scanner").prop('disabled', false);
                })
                .catch(function(err) {
                    console.error("Błąd dostępu do kamery:", err);
                    showError("Nie można uzyskać dostępu do kamery: " + err.message);
                    $("#start-scanner").prop('disabled', false);
                    $("#camera-permission-info").show();
                });
        });
        
        // Zatrzymaj skaner po kliknięciu przycisku
        $("#stop-scanner").on("click", function() {
            if (scanner) {
                Quagga.stop();
                scanner = null;
            }
            
            $("#stop-scanner").hide();
            $("#start-scanner").show();
            $("#scanner-message").html("<p>Skaner zatrzymany. Kliknij 'Uruchom skaner kamery', aby rozpocząć skanowanie.</p>").show();
        });
        
        // Przełączenie trybu debugowania
        $("#enable-debug").on("change", function() {
            if (scanner) {
                // Jeśli skaner jest uruchomiony, zrestartuj go z nowymi ustawieniami
                const selectedCameraId = $("#camera-select").val();
                Quagga.stop();
                scanner = null;
                setTimeout(() => initBarcodeScanner(selectedCameraId || null), 300);
            }
            
            if ($(this).is(":checked")) {
                $("#debug-canvas").show();
            } else {
                $("#debug-canvas").hide();
            }
        });
        
        // Obsługa zmiany kamery
        $("#camera-select").on("change", function() {
            if (scanner) {
                const selectedCameraId = $(this).val();
                Quagga.stop();
                scanner = null;
                setTimeout(() => initBarcodeScanner(selectedCameraId || null), 300);
            }
        });
        
        // Wyszukaj produkt po ręcznie wprowadzonym kodzie
        $("#manual-search").on("click", function() {
            const barcode = $("#manual-barcode").val().trim();
            
            if (barcode) {
                searchProductByBarcode(barcode);
            } else {
                showError("Wprowadź kod kreskowy produktu");
            }
        });

        // Obsługa naciśnięcia Enter w polu ręcznego wprowadzania kodu
        $("#manual-barcode").on("keypress", function(e) {
            if (e.which === 13) {
                e.preventDefault();
                $("#manual-search").click();
            }
        });
        
        // Funkcja wysyłająca zapytanie AJAX o produkt na podstawie kodu kreskowego
        function searchProductByBarcode(barcode) {
            $("#loading-spinner").show();
            $("#product-result").hide();
            $("#error-message").hide();
            
            $.ajax({
                url: "{% url 'fridge:ajax_barcode_lookup' %}",
                type: "GET",
                data: { barcode: barcode },
                success: function(response) {
                    $("#loading-spinner").hide();
                    
                    if (response.success) {
                        // Wyświetl formularz dodawania produktu
                        $("#search-status").hide();
                        $("#product-form").show();
                        
                        if (response.exists) {
                            // Jeśli produkt istnieje w bazie, wypełnij formularz jego danymi
                            $("#ingredient").val(response.product.name);
                            $("#ingredient-id").val(response.product.id);
                            $("#barcode").val(barcode);
                            
                            // Jeśli produkt ma domyślną jednostkę, ustaw ją
                            if (response.product.unit) {
                                $("#unit").val(response.product.unit);
                            }
                        } else {
                            // Jeśli produkt nie istnieje w bazie, wypełnij formularz danymi z API
                            $("#ingredient").val(response.product.name);
                            $("#ingredient-id").val("");
                            $("#barcode").val(barcode);
                            $("#product-barcode").text("Kod kreskowy: " + barcode);
                            
                            // Pokaż kategorię, jeśli jest dostępna
                            if (response.product.categories) {
                                $("#product-category").text("Kategoria: " + response.product.categories).show();
                            } else {
                                $("#product-category").hide();
                            }
                            
                            // Pokaż zdjęcie, jeśli jest dostępne
                            if (response.product.image_url) {
                                $("#product-image").attr("src", response.product.image_url).show();
                            } else {
                                $("#product-image").hide();
                            }
                            
                            // Pokaż podobne składniki, jeśli są dostępne
                            if (response.similar_ingredients && response.similar_ingredients.length > 0) {
                                // Wyczyść kontener
                                $("#similar-ingredients").empty();
                                
                                // Dodaj każdy podobny składnik do listy
                                response.similar_ingredients.forEach(function(item) {
                                    var similarity = Math.round(item.similarity * 100);
                                    var unitText = item.unit_name ? ` (domyślna jednostka: ${item.unit_name})` : '';
                                    
                                    var listItem = $(`
                                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                                               data-id="${item.id}" 
                                               data-name="${item.name}" 
                                               data-unit="${item.unit || ''}">
                                            <div>
                                                <strong>${item.name}</strong>
                                                <small class="d-block text-muted">${unitText}</small>
                                            </div>
                                            <span class="badge bg-primary rounded-pill">${similarity}% zgodności</span>
                                        </button>
                                    `);
                                    
                                    $("#similar-ingredients").append(listItem);
                                });
                                
                                // Pokaż kontener z podobnymi składnikami
                                $("#similar-ingredients-container").show();
                            } else {
                                $("#similar-ingredients-container").hide();
                            }
                        }
                    } else {
                        // Wyświetl błąd
                        $("#search-status").html("<p class='text-danger'>Błąd: " + response.error + "</p>").show();
                    }
                },
                error: function() {
                    $("#search-status").html("<p class='text-danger'>Wystąpił błąd podczas komunikacji z serwerem</p>").show();
                }
            });
        }
        
        // Obsługa kliknięcia na podobny składnik
        $(document).on("click", "#similar-ingredients .list-group-item", function() {
            var id = $(this).data("id");
            var name = $(this).data("name");
            var unit = $(this).data("unit");
            
            // Wypełnij formularz danymi wybranego składnika
            $("#ingredient").val(name);
            $("#ingredient-id").val(id);
            
            // Jeśli składnik ma domyślną jednostkę, ustaw ją
            if (unit) {
                $("#unit").val(unit);
            }
            
            // Ukryj listę podobnych składników
            $("#similar-ingredients-container").hide();
        });
        
        // Obsługa przycisku "Dodaj jako nowy składnik"
        $("#use-new-product").click(function() {
            // Ukryj listę podobnych składników
            $("#similar-ingredients-container").hide();
        });
        
        // Obsługa formularza dodawania produktu do lodówki
        $("#add-product-form").on("submit", function(e) {
            e.preventDefault();
            
            const amount = $("#amount").val();
            const unit = $("#unit").val();
            const expiryDate = $("#expiry_date").val();
            const ingredient = $("#ingredient").val();
            const ingredientId = $("#ingredient-id").val();
            const barcode = $("#barcode").val();
            
            if (!amount || !unit) {
                showError("Wypełnij wszystkie wymagane pola formularza");
                return;
            }
            
            // Dodaj produkt do lodówki
            $.ajax({
                url: "{% url 'fridge:add_scanned_product' %}",
                type: "POST",
                data: {
                    ingredient: ingredient,
                    amount: amount,
                    unit: unit,
                    expiry_date: expiryDate,
                    barcode: barcode,
                    ingredient_id: ingredientId,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    if (response.success) {
                        // Przekieruj do listy produktów
                        window.location.href = response.redirect || "{% url 'fridge:list' %}";
                    } else {
                        showError(response.error || "Wystąpił błąd podczas dodawania produktu do lodówki");
                    }
                },
                error: function(xhr, status, error) {
                    showError("Wystąpił błąd podczas dodawania produktu do lodówki: " + error);
                }
            });
        });
        
        // Funkcja wyświetlająca komunikat o błędzie
        function showError(message) {
            $("#error-message").text(message).show();
        }
    });
</script>
{% endblock %} 